#!/bin/bash

##########################################################################################
##########################################################################################
##########################################################################################
#  UBUNTU: FSE CLIENT INSTALLER
##########################################################################################
#				                              version 1.0
##########################################################################################
#
#				                        created by: James White
#				                                 CIDSE
#				                        Arizona State University
#				                        last updated Feb 14, 2018
#
##########################################################################################
##########################################################################################
##########################################################################################
##########################################################################################

##########################################################################################
#########################      Copy Installation Directory      ##########################
##########################################################################################

cp -a /media/techs/UUI/preseed/install /root/; \


##########################################################################################
#########################            UPDATE & UPGRADE           ##########################
##########################################################################################
apt-get update && apt-get -y upgrade; \


##########################################################################################
##########################################################################################
#########################         Configure Login Screen        ##########################
##########################################################################################

cp /install/fse/login/lightdm.conf /etc/lightdm/
chown root:root /etc/lightdm/lightdm.conf
chmod a+x /etc/lightdm/lightdm.conf
#service lightdm restart

##########################################################################################

echo "root:WatchingPaintDry?138" | chpasswd

##########################################################################################
######################           Copy Provisioning Directory     #########################
##########################################################################################

mkdir /install/
cp -a /root/install/. /install/
chown -R techs /install/

##########################################################################################
##########################################################################################
###########################        Set Install Background          #######################
##########################################################################################

cp /install/backgrounds/warty-final-ubuntu.png /usr/share/backgrounds/
chown root:root /usr/share/backgrounds/warty-final-ubuntu.png
chmod 744 /usr/share/backgrounds/warty-final-ubuntu.png



##########################################################################################
##########################################################################################
##########################################################################################
############################             Add Repositories              ###################
##########################################################################################

sudo wget -O - http://repo.pbis.beyondtrust.com/apt/RPM-GPG-KEY-pbis | sudo apt-key add - 
sudo wget -O /etc/apt/sources.list.d/pbiso.list http://repo.pbis.beyondtrust.com/apt/pbiso.list 
sudo apt-get update
##########################################################################################
##########################################################################################


##########################################################################################
##########################################################################################
##########################################################################################
##########################################################################################
############################						                   ###################
############################	           BASE UTILITIES  	           ###################
############################						                   ###################
##########################################################################################
##########################################################################################
##########################################################################################

##########################################################################################
######################                   OPEN SSH                    #####################
##########################################################################################

apt-get install openssh-server -y

##########################################################################################

##########################################################################################
######################                   CIFS-UTILS                  #####################
##########################################################################################

apt install cifs-utils -y

##########################################################################################

##########################################################################################
######################                      GKSU                     #####################
##########################################################################################

apt-get install gksu -y

##########################################################################################
############################               CLAMAV                    #####################
##########################################################################################

apt-get install clamav-daemon -y
apt-get install clamtk -y

##########################################################################################
##########################           Install PBIS Client        ##########################
##########################################################################################

apt-get install pbis-open -y

##########################################################################################

##########################################################################################
##########################     Install Landscape Client         ##########################
##########################################################################################

apt install landscape-client -y

##########################################################################################


##########################################################################################
######################            MOUNT SOURCE FILESHARE	         #####################
##########################################################################################

echo “Installing CIFS-UTILS”
apt-get install cifs-utils -y

echo “Making New Source Directory”
mkdir /mnt/source/

echo “Mounting CIDSE-FS-01”
mount.cifs //cidse-fs-01.cidse.dhcp.asu.edu/Source /mnt/source -o vers=3.0,username=deploy,domain=cidse-fs-01,password=hiywabk2DAY!
/
##########################################################################################

#sleep 10

##########################################################################################
##########################################################################################
##########################################################################################
######################                               		         #####################
######################            PREPARE FOR PROVISIONING           #####################
######################                 CONFIGURATION                 #####################
##########################################################################################
##########################################################################################
##########################################################################################

rm -R /home/techs/.config/
cp -a /install/fse/profiles/techs/.config/ /home/techs/.config/
chown -R techs /home/techs/

##########################################################################################

##########################################################################################
##########################################################################################
######################         Configure First Run Scripts       	######################
##########################################################################################

cp /mnt/source/linux/ubuntu/provisioning/fse/scripts/fse_provisioning.sh /tmp/fse_provisioning.sh

##########################################################################################
##########################################################################################
###########################    Set Temporary FSE Background        #######################
##########################################################################################

rm /usr/share/backgrounds/warty-final-ubuntu.png
cp /mnt/source/linux/ubuntu/provisioning/fse/backgrounds/warty-final-ubuntu.png /usr/share/backgrounds/
chown root:root /usr/share/backgrounds/warty-final-ubuntu.png
chmod 744 /usr/share/backgrounds/warty-final-ubuntu.png

#service lightdm restart

##########################################################################################
#################################     SET HOSTNAME      ##################################
##########################################################################################

#Assign existing hostname to $hostn
hostn=$(cat /etc/hostname)

#Display existing hostname
#echo "The current hostname of this systems is $hostn"

#Ask for new hostname $newhost

echo " ******************************************************************************"
echo " ******************************************************************************"
echo " Please enter the desired hostname for this system: "
read newhost
echo " ******************************************************************************"
echo " ******************************************************************************"
#change hostname in /etc/hosts & /etc/hostname
sed -i "s/$hostn/$newhost/g" /etc/hosts
sed -i "s/$hostn/$newhost/g" /etc/hostname
echo " **********************************************************************************"
echo " **********************************************************************************"
#display new hostname
echo "Your new hostname is $newhost"
echo " **********************************************************************************"
echo " **********************************************************************************"

hostname $newhost



##########################################################################################
#################################   ACTIVE DIRECTORY  ####################################
##########################################################################################
echo " **********************************************************************************"
echo " **********************************************************************************"
echo " **********************************************************************************"
echo " *************                 **WARNING**                   **********************"
echo " **********************************************************************************"
echo " **********************************************************************************"
echo " *************      ALL NEW SYSTEMS MUST BE PRE-STAGED       **********************"
echo " *************         WITHIN ACTIVE DIRECTORY               **********************"
echo " **********************************************************************************"
echo " **********************************************************************************"
echo " *************   ARE YOU SETTING UP AN EXISTING SYSTEM ???   **********************"
echo " *************         PLEASE VERIFY THAT THE DEVICE         **********************"
echo " *************            IS IN THE PROPER OU                **********************"
echo " **********************************************************************************"

##########################################################################################
##############################    Verify AD PreStage    ##################################
##########################################################################################
#Require the technician to verify whether or not the computer has been prestaged in AD. 
echo " **********************************************************************************"
echo " **********************************************************************************"
echo " *"
echo " *"
read -p " *  Has this computer already been pre-staged in Active Directory? (Y)es/(N)o?  " choice
case "$choice" in 
  y|Y ) echo "yes";;
  n|N ) echo "****************************************************************************"
        echo "****************************************************************************"
        echo "****************************************************************************"
        echo "        UBUNTU CLIENT CONFIGURATION CAN NOT BE RUN AT THIS TIME :(          "
        echo "Please pre-stage this system in Active Directory, with the desired hostname"
        echo "****************************************************************************"; return;;
  * ) echo "invalid"; return;;
esac
echo " **********************************************************************************"
echo " **********************************************************************************"

################################################################################################
#################################   Department Info.    ########################################
################################################################################################



################################################################################################


################################################################################################
################################################################################################
#############################   GET NEW CLIENT CONFIGURATION             #######################
################################################################################################

cp /mnt/source/linux/ubuntu/config/cidse/workstation/workstation_config.sh /tmp/

rm /home/techs/Desktop/fse_provisioning.txt
touch /var/log/fse/fse_provisioning.txt

################################################################################
#####################       RUN POST-CONFIG SCRIPT.      #######################
################################################################################

sh /tmp/workstation_config.sh  --verbose



##########################################################################################
##########################################################################################
################################        CLEANUP         ##################################
##########################################################################################
##########################################################################################
##########################################################################################
rm /install
rm /home/techs/Desktop/firstinstallstarted.txt
touch /var/log/fse.log

##########################################################################################

service lightdm restart
